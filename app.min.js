let featuredRestaurants=[],allRestaurants=[],map=null,markers=[];function formatCategory(e){return Array.isArray(e)?e.join(" & "):e||""}function categoryMatchesQuery(e,t){return Array.isArray(e)?e.some(e=>e.toLowerCase().includes(t)):e&&e.toLowerCase().includes(t)}document.addEventListener("DOMContentLoaded",async()=>{await loadRestaurants(),initMapToggle(),initHeroSearch()});let mapInitialized=!1;function initMapToggle(){const e=document.getElementById("mapToggle"),t=document.getElementById("mapContainer");if(!e||!t)return;const n=window.innerWidth<=768;n||(t.classList.add("show"),e.textContent="Hide Map",initMap(),mapInitialized=!0),e.addEventListener("click",()=>{const n=t.classList.toggle("show");e.textContent=n?"Hide Map":"Show Map",n&&!mapInitialized?(initMap(),mapInitialized=!0):n&&map&&setTimeout(()=>{if(map.invalidateSize(),markers.length>0){const e=L.featureGroup(markers);map.fitBounds(e.getBounds().pad(.1))}},100)})}const townFiles=[{file:"branford-restaurants.json",town:"Branford"},{file:"guilford-restaurants.json",town:"Guilford"},{file:"easthaven-restaurants.json",town:"East Haven"},{file:"madison-restaurants.json",town:"Madison"},{file:"clinton-restaurants.json",town:"Clinton"},{file:"westbrook-restaurants.json",town:"Westbrook"},{file:"old-saybrook-restaurants.json",town:"Old Saybrook"}];async function loadRestaurants(){try{const[e,...t]=await Promise.all([fetch("featured-restaurants.json"),...townFiles.map(e=>fetch(e.file).catch(()=>null))]),n=await e.json();featuredRestaurants=n.featured||[],allRestaurants=[];const a=t.map(async(e,t)=>{if(!e)return[];try{const n=await e.json();if(n.restaurants)return n.restaurants.map(e=>({...e,town:townFiles[t].town}))}catch(e){console.log(`No data file for ${townFiles[t].town} yet`)}return[]}),o=await Promise.all(a);allRestaurants=o.flat()}catch(e){console.error("Error loading restaurants:",e),featuredRestaurants=[],allRestaurants=[]}}const townColors={"East Haven":"#8B5CF6",Branford:"#1e3a6e",Guilford:"#059669",Madison:"#EA580C",Clinton:"#DC2626",Westbrook:"#0891B2","Old Saybrook":"#9F1239"};function isFeaturedRestaurant(e){return featuredRestaurants.some(t=>t.name===e)}function createMarkerIcon(e,t){const n=townColors[e]||"#1e3a6e",a=t?40:24,o=t?"#f0b323":n,r=t?n:"#f0b323",s=t?12:8;return L.divIcon({className:"custom-marker",html:`<div style="\n            background-color: ${o};\n            width: ${a}px;\n            height: ${a}px;\n            border-radius: 50% 50% 50% 0;\n            transform: rotate(-45deg);\n            border: ${t?"3px":"2px"} solid ${r};\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            ${t?"box-shadow: 0 3px 10px rgba(0,0,0,0.3);":""}\n        "><span style="\n            transform: rotate(45deg);\n            width: ${s}px;\n            height: ${s}px;\n            background-color: ${t?n:"white"};\n            border-radius: 50%;\n        "></span></div>`,iconSize:[a,a],iconAnchor:[a/2,a],popupAnchor:[0,-a]})}function initMap(){if(!document.querySelector('link[href*="leaflet.css"]')){const e=document.createElement("link");e.rel="stylesheet",e.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",document.head.appendChild(e)}map=L.map("mapContainer").setView([41.28,-72.62],11),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map),addMarkersToMap(allRestaurants)}function addMarkersToMap(e){if(markers.forEach(e=>map.removeLayer(e)),markers=[],e.forEach(e=>{if(e.lat&&e.lng){const t=isFeaturedRestaurant(e.name),n=createMarkerIcon(e.town,t),a=formatCategory(e.category||e.cuisine),o=L.marker([e.lat,e.lng],{icon:n,zIndexOffset:t?1e3:0}).addTo(map).bindPopup(`\n                    <div class="map-popup">\n                        <h4>${e.name}</h4>\n                        ${t?'<p class="popup-featured">⭐ FEATURED</p>':""}\n                        <p class="popup-cuisine">${a}</p>\n                        <p>${e.town}</p>\n                        ${e.address?`<p>${e.address}</p>`:""}\n                        ${e.phone?`<p>${e.phone}</p>`:""}\n                        ${e.website?`<a href="${e.website}" target="_blank" rel="noopener noreferrer" style="color: #2EA3F2; text-decoration: none;">Visit Website →</a>`:""}\n                    </div>\n                `);markers.push(o)}}),markers.length>0){const e=L.featureGroup(markers);map.fitBounds(e.getBounds().pad(.1))}}function renderRestaurants(e,t=!1){const n=document.getElementById("restaurantGrid"),a=document.getElementById("resultsCount"),o=document.querySelector(".restaurants h2");a.textContent=e.length,o&&(o.textContent=t?"Search Results":"Featured Restaurants"),0!==e.length?n.innerHTML=e.map(e=>{const t=formatCategory(e.category||e.cuisine),n=e.website,a=isFeaturedRestaurant(e.name);let o="restaurant-card",r="";return n&&(o+=" clickable"),!0===e.enhanced?(o+=" premium-card",r='<span class="card-badge premium-badge">Premium</span>'):a&&(o+=" featured-card",r='<span class="card-badge featured-badge">Featured</span>'),`\n        <article class="${o}"${n?` onclick="window.open('${e.website}', '_blank')"`:""}>\n            ${r}\n            ${e.image?`\n            <div class="card-logo${e.darkBg?" dark-bg":""}">\n                <img src="${e.image}" alt="${e.name} logo" loading="lazy">\n            </div>\n            `:""}\n            <div class="card-header">\n                <h3>${e.name}</h3>\n                <span class="cuisine">${t}</span>\n            </div>\n            <div class="card-body">\n                ${e.town?`<span class="town">${e.town}</span>`:""}\n                ${e.address?`<p class="address">${e.address}</p>`:""}\n                ${e.phone?`<p class="phone"><a href="tel:${e.phone.replace(/[^0-9]/g,"")}" onclick="event.stopPropagation()">${e.phone}</a></p>`:""}\n            </div>\n            ${n?'\n            <div class="card-footer">\n                <span class="website-hint">Click to visit website →</span>\n            </div>\n            ':""}\n        </article>\n    `}).join(""):n.innerHTML=`\n            <div class="no-results">\n                <h3>No restaurants found</h3>\n                <p>${t?"Try a different search term.":"Check back soon for featured restaurants."}</p>\n            </div>\n        `}function initHeroSearch(){const e=document.getElementById("heroSearch"),t=document.getElementById("heroSearchBtn");function n(){const t=e.value.toLowerCase().trim();if(!t)return renderRestaurants(featuredRestaurants,!1),void addMarkersToMap(featuredRestaurants);const n=allRestaurants.filter(e=>e.name.toLowerCase().includes(t)||categoryMatchesQuery(e.cuisine,t)||categoryMatchesQuery(e.category,t)||e.town.toLowerCase().includes(t));n.sort((e,t)=>{const n=isFeaturedRestaurant(e.name),a=isFeaturedRestaurant(t.name),o=!0===e.enhanced?1:n?2:0,r=!0===t.enhanced?1:a?2:0;return o!==r?r-o:e.name.localeCompare(t.name)}),renderRestaurants(n,!0),addMarkersToMap(n),document.getElementById("restaurants").scrollIntoView({behavior:"smooth",block:"start"})}e&&t&&(t.addEventListener("click",n),e.addEventListener("keypress",e=>{"Enter"===e.key&&n()}))}function calculateDistance(e,t,n,a){const o=(n-e)*Math.PI/180,r=(a-t)*Math.PI/180,s=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 3959*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))}function initNearMe(){const e=document.getElementById("nearMeBtn"),t=document.getElementById("nearMeModal"),n=document.getElementById("nearMeClose");e&&t&&(e.addEventListener("click",()=>{t.classList.add("show"),getUserLocation()}),n.addEventListener("click",()=>{t.classList.remove("show")}),t.addEventListener("click",e=>{e.target===t&&t.classList.remove("show")}))}function getUserLocation(){const e=document.getElementById("nearMeLoading"),t=document.getElementById("nearMeError"),n=document.getElementById("nearMeResults");e.style.display="flex",t.style.display="none",n.style.display="none",navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{findNearbyRestaurants(e.coords.latitude,e.coords.longitude)},e=>{let t="Unable to get your location.";1===e.code?t="Location access denied. Please enable location services and try again.":2===e.code?t="Location unavailable. Please try again.":3===e.code&&(t="Location request timed out. Please try again."),showNearMeError(t)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5}):showNearMeError("Geolocation is not supported by your browser.")}function showNearMeError(e){const t=document.getElementById("nearMeLoading"),n=document.getElementById("nearMeError");t.style.display="none",n.style.display="block",n.querySelector("p").textContent=e}function isEnhancedRestaurant(e){return allRestaurants.some(t=>t.name===e&&!0===t.enhanced)}function findNearbyRestaurants(e,t){const n=document.getElementById("nearMeLoading"),a=document.getElementById("nearMeResults"),o=document.getElementById("nearMeFeatured"),r=document.getElementById("nearMeOthers"),s=featuredRestaurants.filter(e=>e.lat&&e.lng).map(n=>({...n,distance:calculateDistance(e,t,n.lat,n.lng),isFeatured:!0})).sort((e,t)=>e.distance-t.distance),i=allRestaurants.filter(e=>e.lat&&e.lng).map(n=>{const a=isFeaturedRestaurant(n.name),o=a?featuredRestaurants.find(e=>e.name===n.name):null;return{...n,website:o?.website||n.website,distance:calculateDistance(e,t,n.lat,n.lng),isFeatured:a,isEnhanced:!0===n.enhanced}}).sort((e,t)=>e.distance-t.distance);if(n.style.display="none",a.style.display="block",s.length>0){const e=s.slice(0,2);o.innerHTML=`\n            <div class="near-me-section-header">\n                <h3>Nearest Featured Restaurants</h3>\n                <button class="near-me-section-close" id="closeFeatured">&times;</button>\n            </div>\n            ${e.map(e=>`\n            <div class="near-me-card featured">\n                ${e.image?`<img src="${e.image}" alt="${e.name}" class="near-me-img${e.darkBg?" dark-bg":""}" loading="lazy">`:""}\n                <div class="near-me-info">\n                    <h4>${e.name}</h4>\n                    <span class="near-me-distance">${e.distance.toFixed(1)} miles away</span>\n                    <p class="near-me-cuisine">${formatCategory(e.category||e.cuisine)}</p>\n                    <p class="near-me-town">${e.town}</p>\n                    ${e.address?`<p class="near-me-address">${e.address}</p>`:""}\n                    ${e.phone?`<p class="near-me-phone">${e.phone}</p>`:""}\n                    <div class="near-me-actions">\n                        ${e.website?`<a href="${e.website}" target="_blank" rel="noopener noreferrer" class="near-me-link">Website</a>`:""}\n                        <a href="https://www.google.com/maps/dir/?api=1&destination=${e.lat},${e.lng}" target="_blank" rel="noopener noreferrer" class="near-me-link directions">Directions</a>\n                    </div>\n                </div>\n            </div>\n            `).join("")}\n        `,document.getElementById("closeFeatured").addEventListener("click",()=>{o.style.display="none";const e=document.querySelector(".near-me-list");e&&e.classList.add("expanded")})}else o.innerHTML="<p>No featured restaurants found with location data.</p>";i.length>0?r.innerHTML=`\n            <h3>All Restaurants by Distance (${i.length})</h3>\n            <div class="near-me-list">\n                ${i.map(e=>{let t="near-me-card small",n="";e.isEnhanced?(t+=" near-me-enhanced-highlight",n='<span class="near-me-badge enhanced-badge">Premium</span>'):e.isFeatured&&(t+=" near-me-featured-highlight",n='<span class="near-me-badge featured-badge">Featured</span>');const a=e.isFeatured||e.isEnhanced;return`\n                    <div class="${t}">\n                        <div class="near-me-info">\n                            <h4>${e.name} ${n}</h4>\n                            <span class="near-me-distance">${e.distance.toFixed(1)} mi</span>\n                            <p class="near-me-meta">${formatCategory(e.category)} · ${e.town}</p>\n                            ${a&&e.phone?`<p class="near-me-phone-visible">${e.phone}</p>`:""}\n                            ${e.website?`<a href="${e.website}" target="_blank" rel="noopener noreferrer" class="near-me-link">Website</a>`:""}\n                            <a href="https://www.google.com/maps/dir/?api=1&destination=${e.lat},${e.lng}" target="_blank" rel="noopener noreferrer" class="near-me-link directions">Directions</a>\n                        </div>\n                    </div>\n                `}).join("")}\n            </div>\n        `:r.innerHTML="<p>No restaurants found with location data.</p>"}function initReportModal(){const e=document.getElementById("reportLink"),t=document.getElementById("reportModal"),n=document.getElementById("reportClose"),a=document.getElementById("reportForm");t&&(e&&e.addEventListener("click",e=>{e.preventDefault(),t.classList.add("show")}),n&&n.addEventListener("click",()=>{t.classList.remove("show")}),t.addEventListener("click",e=>{e.target===t&&t.classList.remove("show")}),a&&a.addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("reportRestaurant").value,n=document.getElementById("reportTown").value,o=document.getElementById("reportType").value,r=document.getElementById("reportDetails").value,s=document.getElementById("reportEmail").value,i=`Problem Report: ${t} (${n})`;let l="Problem Report for A Bite of Nutmeg\n";l+=`${"=".repeat(40)}\n\n`,l+=`Restaurant: ${t}\n`,l+=`Town: ${n}\n`,l+=`Problem Type: ${o}\n\n`,l+=`Details:\n${r||"No additional details provided."}\n\n`,s&&(l+=`Reporter Email: ${s}\n`),l+=`\n${"=".repeat(40)}\n`,l+="Submitted via A Bite of Nutmeg website";const d=`mailto:chrishauman@gmail.com?subject=${encodeURIComponent(i)}&body=${encodeURIComponent(l)}`;window.location.href=d,setTimeout(()=>{showReportFallback(i,l)},500),a.reset()}))}function showReportFallback(e,t){const n=document.querySelector(".report-modal-content");n&&(n.innerHTML=`\n        <button class="report-close" id="reportCloseFallback">&times;</button>\n        <h2>Thanks for Your Report!</h2>\n        <p>If your email app didn't open, please send this report manually:</p>\n        <div class="report-fallback">\n            <div class="report-email-to">\n                <strong>Email to:</strong>\n                <a href="mailto:chrishauman@gmail.com">chrishauman@gmail.com</a>\n                <button class="copy-btn" id="copyEmail" title="Copy email">Copy</button>\n            </div>\n            <div class="report-subject">\n                <strong>Subject:</strong> ${e}\n            </div>\n            <div class="report-body">\n                <strong>Message:</strong>\n                <pre>${t}</pre>\n                <button class="copy-btn" id="copyBody">Copy Message</button>\n            </div>\n        </div>\n        <button class="report-done" id="reportDone">Done</button>\n    `,document.getElementById("reportCloseFallback").addEventListener("click",resetReportModal),document.getElementById("reportDone").addEventListener("click",resetReportModal),document.getElementById("copyEmail").addEventListener("click",()=>{navigator.clipboard.writeText("chrishauman@gmail.com"),document.getElementById("copyEmail").textContent="Copied!",setTimeout(()=>{document.getElementById("copyEmail").textContent="Copy"},2e3)}),document.getElementById("copyBody").addEventListener("click",()=>{navigator.clipboard.writeText(t),document.getElementById("copyBody").textContent="Copied!",setTimeout(()=>{document.getElementById("copyBody").textContent="Copy Message"},2e3)}))}function resetReportModal(){const e=document.getElementById("reportModal"),t=document.querySelector(".report-modal-content");e&&e.classList.remove("show"),t&&(t.innerHTML='\n            <button class="report-close" id="reportClose">&times;</button>\n            <h2>Report a Problem</h2>\n            <p>Help us keep our directory accurate. Let us know if something\'s wrong.</p>\n            <form id="reportForm">\n                <div class="form-group">\n                    <label for="reportRestaurant">Restaurant Name</label>\n                    <input type="text" id="reportRestaurant" placeholder="e.g., Joe\'s Pizza" required>\n                </div>\n                <div class="form-group">\n                    <label for="reportTown">Town</label>\n                    <select id="reportTown" required>\n                        <option value="">Select a town...</option>\n                        <option value="East Haven">East Haven</option>\n                        <option value="Branford">Branford</option>\n                        <option value="Guilford">Guilford</option>\n                        <option value="Madison">Madison</option>\n                        <option value="Clinton">Clinton</option>\n                        <option value="Westbrook">Westbrook</option>\n                        <option value="Old Saybrook">Old Saybrook</option>\n                    </select>\n                </div>\n                <div class="form-group">\n                    <label for="reportType">Problem Type</label>\n                    <select id="reportType" required>\n                        <option value="">Select issue type...</option>\n                        <option value="Permanently Closed">Restaurant permanently closed</option>\n                        <option value="Wrong Phone">Wrong phone number</option>\n                        <option value="Wrong Address">Wrong address</option>\n                        <option value="Wrong Category">Wrong cuisine/category</option>\n                        <option value="Duplicate Listing">Duplicate listing</option>\n                        <option value="Missing Restaurant">Restaurant not listed</option>\n                        <option value="Other">Other issue</option>\n                    </select>\n                </div>\n                <div class="form-group">\n                    <label for="reportDetails">Details</label>\n                    <textarea id="reportDetails" rows="3" placeholder="Please provide any additional details..."></textarea>\n                </div>\n                <div class="form-group">\n                    <label for="reportEmail">Your Email (optional)</label>\n                    <input type="email" id="reportEmail" placeholder="your@email.com">\n                </div>\n                <button type="submit" class="report-submit">Submit Report</button>\n            </form>\n        ',initReportModal())}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=document.querySelector(this.getAttribute("href"));t&&t.scrollIntoView({behavior:"smooth",block:"start"})})}),document.addEventListener("DOMContentLoaded",initNearMe),document.addEventListener("DOMContentLoaded",initReportModal);