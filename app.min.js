let featuredRestaurants=[],allRestaurants=[],map=null,markers=[];function formatCategory(e){return Array.isArray(e)?e.join(" & "):e||""}function categoryMatchesQuery(e,n){return Array.isArray(e)?e.some(e=>e.toLowerCase().includes(n)):e&&e.toLowerCase().includes(n)}document.addEventListener("DOMContentLoaded",async()=>{await loadRestaurants(),initMapToggle(),initHeroSearch()});let mapInitialized=!1;function initMapToggle(){const e=document.getElementById("mapToggle"),n=document.getElementById("mapContainer");if(!e||!n)return;window.innerWidth<=768||(n.classList.add("show"),e.textContent="Hide Map",initMap(),mapInitialized=!0),e.addEventListener("click",()=>{const t=n.classList.toggle("show");e.textContent=t?"Hide Map":"Show Map",t&&!mapInitialized?(initMap(),mapInitialized=!0):t&&map&&setTimeout(()=>{if(map.invalidateSize(),markers.length>0){const e=L.featureGroup(markers);map.fitBounds(e.getBounds().pad(.1))}},100)})}const townFiles=[{file:"branford-restaurants.json",town:"Branford"},{file:"guilford-restaurants.json",town:"Guilford"},{file:"easthaven-restaurants.json",town:"East Haven"},{file:"madison-restaurants.json",town:"Madison"},{file:"clinton-restaurants.json",town:"Clinton"},{file:"westbrook-restaurants.json",town:"Westbrook"},{file:"old-saybrook-restaurants.json",town:"Old Saybrook"}];async function loadRestaurants(){try{const[e,...n]=await Promise.all([fetch("featured-restaurants.json"),...townFiles.map(e=>fetch(e.file).catch(()=>null))]),t=await e.json();featuredRestaurants=t.featured||[],allRestaurants=[];const a=n.map(async(e,n)=>{if(!e)return[];try{const t=await e.json();if(t.restaurants)return t.restaurants.map(e=>({...e,town:townFiles[n].town}))}catch(e){console.log(`No data file for ${townFiles[n].town} yet`)}return[]}),o=await Promise.all(a);allRestaurants=o.flat()}catch(e){console.error("Error loading restaurants:",e),featuredRestaurants=[],allRestaurants=[]}}const townColors={"East Haven":"#8B5CF6",Branford:"#1e3a6e",Guilford:"#059669",Madison:"#EA580C",Clinton:"#DC2626",Westbrook:"#0891B2","Old Saybrook":"#9F1239"};function isFeaturedRestaurant(e){return featuredRestaurants.some(n=>n.name===e)}function createMarkerIcon(e,n){const t=townColors[e]||"#1e3a6e",a=n?40:24,o=n?"#f0b323":t,r=n?t:"#f0b323",s=n?12:8;return L.divIcon({className:"custom-marker",html:`<div style="\n            background-color: ${o};\n            width: ${a}px;\n            height: ${a}px;\n            border-radius: 50% 50% 50% 0;\n            transform: rotate(-45deg);\n            border: ${n?"3px":"2px"} solid ${r};\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            ${n?"box-shadow: 0 3px 10px rgba(0,0,0,0.3);":""}\n        "><span style="\n            transform: rotate(45deg);\n            width: ${s}px;\n            height: ${s}px;\n            background-color: ${n?t:"white"};\n            border-radius: 50%;\n        "></span></div>`,iconSize:[a,a],iconAnchor:[a/2,a],popupAnchor:[0,-a]})}function initMap(){if(!document.querySelector('link[href*="leaflet.css"]')){const e=document.createElement("link");e.rel="stylesheet",e.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",document.head.appendChild(e)}map=L.map("mapContainer").setView([41.28,-72.62],11),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map),addMarkersToMap(allRestaurants)}function addMarkersToMap(e){if(markers.forEach(e=>map.removeLayer(e)),markers=[],e.forEach(e=>{if(e.lat&&e.lng){const n=isFeaturedRestaurant(e.name),t=createMarkerIcon(e.town,n),a=formatCategory(e.category||e.cuisine),o=L.marker([e.lat,e.lng],{icon:t,zIndexOffset:n?1e3:0}).addTo(map).bindPopup(`\n                    <div class="map-popup">\n                        <h4>${e.name}</h4>\n                        ${n?'<p class="popup-featured">⭐ FEATURED</p>':""}\n                        <p class="popup-cuisine">${a}</p>\n                        <p>${e.town}</p>\n                        ${e.address?`<p>${e.address}</p>`:""}\n                        ${e.phone?`<p>${e.phone}</p>`:""}\n                        ${e.website?`<a href="${e.website}" target="_blank" rel="noopener noreferrer" style="color: #2EA3F2; text-decoration: none;">Visit Website →</a>`:""}\n                    </div>\n                `);markers.push(o)}}),markers.length>0){const e=L.featureGroup(markers);map.fitBounds(e.getBounds().pad(.1))}}function renderRestaurants(e,n=!1){const t=document.getElementById("restaurantGrid"),a=document.getElementById("resultsCount"),o=document.querySelector(".restaurants h2");a.textContent=e.length,o&&(o.textContent=n?"Search Results":"Featured Restaurants"),0!==e.length?t.innerHTML=e.map(e=>{const n=formatCategory(e.category||e.cuisine),t=e.website,a=isFeaturedRestaurant(e.name);let o="restaurant-card",r="";return t&&(o+=" clickable"),!0===e.enhanced?(o+=" premium-card",r='<span class="card-badge premium-badge">Premium</span>'):a&&(o+=" featured-card",r='<span class="card-badge featured-badge">Featured</span>'),`\n        <article class="${o}"${t?` onclick="window.open('${e.website}', '_blank')"`:""}>\n            ${r}\n            ${e.image?`\n            <div class="card-logo${e.darkBg?" dark-bg":""}">\n                <img src="${e.image}" alt="${e.name} logo" width="140" height="100" loading="lazy">\n            </div>\n            `:""}\n            <div class="card-header">\n                <h3>${e.name}</h3>\n                <span class="cuisine">${n}</span>\n            </div>\n            <div class="card-body">\n                ${e.town?`<span class="town">${e.town}</span>`:""}\n                ${e.address?`<p class="address">${e.address}</p>`:""}\n                ${e.phone?`<p class="phone"><a href="tel:${e.phone.replace(/[^0-9]/g,"")}" onclick="event.stopPropagation()">${e.phone}</a></p>`:""}\n            </div>\n            ${t?'\n            <div class="card-footer">\n                <span class="website-hint">Click to visit website →</span>\n            </div>\n            ':""}\n        </article>\n    `}).join(""):t.innerHTML=`\n            <div class="no-results">\n                <h3>No restaurants found</h3>\n                <p>${n?"Try a different search term.":"Check back soon for featured restaurants."}</p>\n            </div>\n        `}function initHeroSearch(){const e=document.getElementById("heroSearch"),n=document.getElementById("heroSearchBtn");function t(){const n=e.value.toLowerCase().trim();if(!n)return renderRestaurants(featuredRestaurants,!1),void addMarkersToMap(featuredRestaurants);const t=allRestaurants.filter(e=>e.name.toLowerCase().includes(n)||categoryMatchesQuery(e.cuisine,n)||categoryMatchesQuery(e.category,n)||e.town.toLowerCase().includes(n));t.sort((e,n)=>{const t=isFeaturedRestaurant(e.name),a=isFeaturedRestaurant(n.name),o=!0===e.enhanced?1:t?2:0,r=!0===n.enhanced?1:a?2:0;return o!==r?r-o:e.name.localeCompare(n.name)}),renderRestaurants(t,!0),addMarkersToMap(t),document.getElementById("restaurants").scrollIntoView({behavior:"smooth",block:"start"})}e&&n&&(n.addEventListener("click",t),e.addEventListener("keypress",e=>{"Enter"===e.key&&t()}))}function calculateDistance(e,n,t,a){const o=(t-e)*Math.PI/180,r=(a-n)*Math.PI/180,s=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e*Math.PI/180)*Math.cos(t*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 3959*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))}function initNearMe(){const e=document.getElementById("nearMeBtn"),n=document.getElementById("nearMeModal"),t=document.getElementById("nearMeClose");e&&n&&(e.addEventListener("click",()=>{n.classList.add("show"),getUserLocation()}),t.addEventListener("click",()=>{n.classList.remove("show")}),n.addEventListener("click",e=>{e.target===n&&n.classList.remove("show")}))}function getUserLocation(){const e=document.getElementById("nearMeLoading"),n=document.getElementById("nearMeError"),t=document.getElementById("nearMeResults");e.style.display="flex",n.style.display="none",t.style.display="none",navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{findNearbyRestaurants(e.coords.latitude,e.coords.longitude)},e=>{let n="Unable to get your location.";1===e.code?n="Location access denied. Please enable location services and try again.":2===e.code?n="Location unavailable. Please try again.":3===e.code&&(n="Location request timed out. Please try again."),showNearMeError(n)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5}):showNearMeError("Geolocation is not supported by your browser.")}function showNearMeError(e){const n=document.getElementById("nearMeLoading"),t=document.getElementById("nearMeError");n.style.display="none",t.style.display="block",t.querySelector("p").textContent=e}function isEnhancedRestaurant(e){return allRestaurants.some(n=>n.name===e&&!0===n.enhanced)}function findNearbyRestaurants(e,n){const t=document.getElementById("nearMeLoading"),a=document.getElementById("nearMeResults"),o=document.getElementById("nearMeFeatured"),r=document.getElementById("nearMeOthers"),s=featuredRestaurants.filter(e=>e.lat&&e.lng).map(t=>({...t,distance:calculateDistance(e,n,t.lat,t.lng),isFeatured:!0})).sort((e,n)=>e.distance-n.distance),i=allRestaurants.filter(e=>e.lat&&e.lng).map(t=>{const a=isFeaturedRestaurant(t.name),o=a?featuredRestaurants.find(e=>e.name===t.name):null;return{...t,website:o?.website||t.website,distance:calculateDistance(e,n,t.lat,t.lng),isFeatured:a,isEnhanced:!0===t.enhanced}}).sort((e,n)=>e.distance-n.distance);if(t.style.display="none",a.style.display="block",s.length>0){const e=s.slice(0,2);o.innerHTML=`\n            <div class="near-me-section-header">\n                <h3>Nearest Featured Restaurants</h3>\n                <button class="near-me-section-close" id="closeFeatured">&times;</button>\n            </div>\n            ${e.map(e=>`\n            <div class="near-me-card featured">\n                ${e.image?`<img src="${e.image}" alt="${e.name}" class="near-me-img${e.darkBg?" dark-bg":""}" width="100" height="100" loading="lazy">`:""}\n                <div class="near-me-info">\n                    <h4>${e.name}</h4>\n                    <span class="near-me-distance">${e.distance.toFixed(1)} miles away</span>\n                    <p class="near-me-cuisine">${formatCategory(e.category||e.cuisine)}</p>\n                    <p class="near-me-town">${e.town}</p>\n                    ${e.address?`<p class="near-me-address">${e.address}</p>`:""}\n                    ${e.phone?`<p class="near-me-phone">${e.phone}</p>`:""}\n                    <div class="near-me-actions">\n                        ${e.website?`<a href="${e.website}" target="_blank" rel="noopener noreferrer" class="near-me-link">Website</a>`:""}\n                        <a href="https://www.google.com/maps/dir/?api=1&destination=${e.lat},${e.lng}" target="_blank" rel="noopener noreferrer" class="near-me-link directions">Directions</a>\n                    </div>\n                </div>\n            </div>\n            `).join("")}\n        `,document.getElementById("closeFeatured").addEventListener("click",()=>{o.style.display="none";const e=document.querySelector(".near-me-list");e&&e.classList.add("expanded")})}else o.innerHTML="<p>No featured restaurants found with location data.</p>";i.length>0?r.innerHTML=`\n            <h3>All Restaurants by Distance (${i.length})</h3>\n            <div class="near-me-list">\n                ${i.map(e=>{let n="near-me-card small",t="";e.isEnhanced?(n+=" near-me-enhanced-highlight",t='<span class="near-me-badge enhanced-badge">Premium</span>'):e.isFeatured&&(n+=" near-me-featured-highlight",t='<span class="near-me-badge featured-badge">Featured</span>');const a=e.isFeatured||e.isEnhanced;return`\n                    <div class="${n}">\n                        <div class="near-me-info">\n                            <h4>${e.name} ${t}</h4>\n                            <span class="near-me-distance">${e.distance.toFixed(1)} mi</span>\n                            <p class="near-me-meta">${formatCategory(e.category)} · ${e.town}</p>\n                            ${a&&e.phone?`<p class="near-me-phone-visible">${e.phone}</p>`:""}\n                            ${e.website?`<a href="${e.website}" target="_blank" rel="noopener noreferrer" class="near-me-link">Website</a>`:""}\n                            <a href="https://www.google.com/maps/dir/?api=1&destination=${e.lat},${e.lng}" target="_blank" rel="noopener noreferrer" class="near-me-link directions">Directions</a>\n                        </div>\n                    </div>\n                `}).join("")}\n            </div>\n        `:r.innerHTML="<p>No restaurants found with location data.</p>"}function initReportModal(){const e=document.getElementById("reportLink"),n=document.getElementById("reportModal"),t=document.getElementById("reportClose"),a=document.getElementById("reportForm");n&&(e&&e.addEventListener("click",e=>{e.preventDefault(),n.classList.add("show")}),t&&t.addEventListener("click",()=>{n.classList.remove("show")}),n.addEventListener("click",e=>{e.target===n&&n.classList.remove("show")}),a&&a.addEventListener("submit",e=>{e.preventDefault();const n=document.getElementById("reportRestaurant").value,t=document.getElementById("reportTown").value,o=document.getElementById("reportType").value,r=document.getElementById("reportDetails").value,s=document.getElementById("reportEmail").value,i=`Problem Report: ${n} (${t})`;let c="Problem Report for A Bite of Nutmeg\n";c+=`${"=".repeat(40)}\n\n`,c+=`Restaurant: ${n}\n`,c+=`Town: ${t}\n`,c+=`Problem Type: ${o}\n\n`,c+=`Details:\n${r||"No additional details provided."}\n\n`,s&&(c+=`Reporter Email: ${s}\n`),c+=`\n${"=".repeat(40)}\n`,c+="Submitted via A Bite of Nutmeg website";const l=`mailto:chrishauman@gmail.com?subject=${encodeURIComponent(i)}&body=${encodeURIComponent(c)}`;window.location.href=l,setTimeout(()=>{showReportFallback(i,c)},500),a.reset()}))}function showReportFallback(e,n){const t=document.querySelector(".report-modal-content");t&&(t.innerHTML=`\n        <button class="report-close" id="reportCloseFallback">&times;</button>\n        <h2>Thanks for Your Report!</h2>\n        <p>If your email app didn't open, please send this report manually:</p>\n        <div class="report-fallback">\n            <div class="report-email-to">\n                <strong>Email to:</strong>\n                <a href="mailto:chrishauman@gmail.com">chrishauman@gmail.com</a>\n                <button class="copy-btn" id="copyEmail" title="Copy email">Copy</button>\n            </div>\n            <div class="report-subject">\n                <strong>Subject:</strong> ${e}\n            </div>\n            <div class="report-body">\n                <strong>Message:</strong>\n                <pre>${n}</pre>\n                <button class="copy-btn" id="copyBody">Copy Message</button>\n            </div>\n        </div>\n        <button class="report-done" id="reportDone">Done</button>\n    `,document.getElementById("reportCloseFallback").addEventListener("click",resetReportModal),document.getElementById("reportDone").addEventListener("click",resetReportModal),document.getElementById("copyEmail").addEventListener("click",()=>{navigator.clipboard.writeText("chrishauman@gmail.com"),document.getElementById("copyEmail").textContent="Copied!",setTimeout(()=>{document.getElementById("copyEmail").textContent="Copy"},2e3)}),document.getElementById("copyBody").addEventListener("click",()=>{navigator.clipboard.writeText(n),document.getElementById("copyBody").textContent="Copied!",setTimeout(()=>{document.getElementById("copyBody").textContent="Copy Message"},2e3)}))}function resetReportModal(){const e=document.getElementById("reportModal"),n=document.querySelector(".report-modal-content");e&&e.classList.remove("show"),n&&(n.innerHTML='\n            <button class="report-close" id="reportClose">&times;</button>\n            <h2>Report a Problem</h2>\n            <p>Help us keep our directory accurate. Let us know if something\'s wrong.</p>\n            <form id="reportForm">\n                <div class="form-group">\n                    <label for="reportRestaurant">Restaurant Name</label>\n                    <input type="text" id="reportRestaurant" placeholder="e.g., Joe\'s Pizza" required>\n                </div>\n                <div class="form-group">\n                    <label for="reportTown">Town</label>\n                    <select id="reportTown" required>\n                        <option value="">Select a town...</option>\n                        <option value="East Haven">East Haven</option>\n                        <option value="Branford">Branford</option>\n                        <option value="Guilford">Guilford</option>\n                        <option value="Madison">Madison</option>\n                        <option value="Clinton">Clinton</option>\n                        <option value="Westbrook">Westbrook</option>\n                        <option value="Old Saybrook">Old Saybrook</option>\n                    </select>\n                </div>\n                <div class="form-group">\n                    <label for="reportType">Problem Type</label>\n                    <select id="reportType" required>\n                        <option value="">Select issue type...</option>\n                        <option value="Permanently Closed">Restaurant permanently closed</option>\n                        <option value="Wrong Phone">Wrong phone number</option>\n                        <option value="Wrong Address">Wrong address</option>\n                        <option value="Wrong Category">Wrong cuisine/category</option>\n                        <option value="Duplicate Listing">Duplicate listing</option>\n                        <option value="Missing Restaurant">Restaurant not listed</option>\n                        <option value="Other">Other issue</option>\n                    </select>\n                </div>\n                <div class="form-group">\n                    <label for="reportDetails">Details</label>\n                    <textarea id="reportDetails" rows="3" placeholder="Please provide any additional details..."></textarea>\n                </div>\n                <div class="form-group">\n                    <label for="reportEmail">Your Email (optional)</label>\n                    <input type="email" id="reportEmail" placeholder="your@email.com">\n                </div>\n                <button type="submit" class="report-submit">Submit Report</button>\n            </form>\n        ',initReportModal())}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const n=document.querySelector(this.getAttribute("href"));n&&n.scrollIntoView({behavior:"smooth",block:"start"})})}),document.addEventListener("DOMContentLoaded",initNearMe),document.addEventListener("DOMContentLoaded",initReportModal);