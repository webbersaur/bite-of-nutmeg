let data=null,currentCategory="All",searchTerm="",map=null,markers=[];const scriptTag=document.currentScript,townName=scriptTag.getAttribute("data-town"),jsonFile=scriptTag.getAttribute("data-json");function addMobileScrollHints(){const e=document.querySelector(".map-section");if(e&&!document.querySelector(".scroll-down-hint")){const t=document.createElement("p");t.className="scroll-down-hint",t.textContent="Scroll down to view cuisine types ↓",e.after(t)}}async function loadData(){try{const e=await fetch(jsonFile);data=await e.json()}catch(e){console.error("Error loading restaurant data:",e),data={featured:[],restaurants:[],categories:[]}}}function renderCategoryTabs(){const e=document.getElementById("categoryTabs");let t=document.querySelector(".category-scroll-hint");t||(t=document.createElement("p"),t.className="category-scroll-hint",t.textContent="Swipe to see more cuisines →",e.parentNode.insertBefore(t,e)),e.innerHTML=data.categories.map(e=>`\n        <button class="category-tab ${e===currentCategory?"active":""}"\n                data-category="${e}">\n            ${e}\n        </button>\n    `).join(""),e.querySelectorAll(".category-tab").forEach(e=>{e.addEventListener("click",()=>{currentCategory=e.dataset.category,updateActiveTabs(),renderRestaurantList()})})}function updateActiveTabs(){document.querySelectorAll(".category-tab").forEach(e=>{e.classList.toggle("active",e.dataset.category===currentCategory)})}function renderFeaturedRestaurants(){const e=document.getElementById("featuredGrid");data.featured&&0!==data.featured.length?e.innerHTML=data.featured.map(e=>`\n        <a href="${e.website||"#"}" class="featured-card" target="_blank" rel="noopener noreferrer">\n            <div class="card-image ${e.darkBg?"dark-bg":""}">\n                <span class="featured-badge">FEATURED</span>\n                ${e.image?`<img src="${e.image}" alt="${e.name}" width="140" height="100" loading="lazy">`:`<span class="placeholder-logo">${e.name.charAt(0)}</span>`}\n            </div>\n            <div class="card-content">\n                <h3>${e.name}</h3>\n                <span class="category-tag">${e.category}</span>\n                <div class="info-row">\n                    <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>\n                    ${e.address||townName}\n                </div>\n                <div class="info-row">\n                    <svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>\n                    ${e.phone}\n                </div>\n                ${e.website?'<span class="visit-link">Visit Website →</span>':""}\n            </div>\n        </a>\n    `).join(""):e.innerHTML='<p style="text-align: center; color: #666; grid-column: 1/-1;">Featured restaurants coming soon!</p>'}function getFilteredRestaurants(){return data.restaurants.filter(e=>{const t="All"===currentCategory||(Array.isArray(e.category)?e.category.includes(currentCategory):e.category===currentCategory),n=0===searchTerm.length||(()=>{const t=searchTerm.toLowerCase(),n=Array.isArray(e.category)?e.category.join(", "):e.category;return e.name.toLowerCase().includes(t)||n.toLowerCase().includes(t)})();return t&&n})}function renderRestaurantList(){const e=document.getElementById("restaurantList"),t=document.getElementById("resultsCount"),n=getFilteredRestaurants();n.sort((e,t)=>{const n=data.featured&&data.featured.some(t=>t.name===e.name)?2:0,a=data.featured&&data.featured.some(e=>e.name===t.name)?2:0,r=!0===e.enhanced?1:0,o=!0===t.enhanced?1:0;if("All"!==currentCategory){const e=n||r,t=a||o;if(t!==e)return t-e}else if(o!==r)return o-r;return e.name.localeCompare(t.name)}),t.textContent=n.length,0!==n.length?e.innerHTML=n.map(e=>{const t=data.featured&&data.featured.some(t=>t.name===e.name),n=!0===e.enhanced;let a="",r="restaurant-item";t?(a='<span class="list-badge featured">Featured</span>',r+=" featured-highlight"):n&&(a='<span class="list-badge enhanced">Premium</span>',r+=" enhanced-highlight");const o=t?data.featured.find(t=>t.name===e.name):null,s=o?.website||e.website,c=t||n;return`\n        <div class="${r}">\n            <div class="item-header">\n                <h3>${e.name}</h3>\n                ${a}\n            </div>\n            <span class="category">${Array.isArray(e.category)?e.category.join(" & "):e.category}</span>\n            <div class="item-actions">\n                <a href="tel:${e.phone.replace(/[^0-9]/g,"")}" class="phone">\n                    <svg width="14" height="14" viewBox="0 0 24 24" fill="#2EA3F2"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>\n                    ${e.phone}\n                </a>\n                ${c&&s?`<a href="${s}" target="_blank" rel="noopener noreferrer" class="website-link">Visit Website →</a>`:""}\n            </div>\n        </div>\n    `}).join(""):e.innerHTML='\n            <div class="no-results" style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #666;">\n                <h3 style="color: #333; margin-bottom: 0.5rem;">No restaurants found</h3>\n                <p>Try a different category or search term.</p>\n            </div>\n        '}function scrollToResults(){document.activeElement?.blur(),setTimeout(()=>{const e=document.querySelector(".category-section");if(e){const t=e.getBoundingClientRect().top+window.pageYOffset;window.scrollTo({top:t,behavior:"smooth"})}},100)}function initSearch(){const e=document.getElementById("searchInput");if(!e)return;const t=document.getElementById("townSearchBtn");e.addEventListener("input",e=>{searchTerm=e.target.value,renderRestaurantList()}),t&&t.addEventListener("click",()=>{searchTerm=e.value,renderRestaurantList(),scrollToResults()}),e.addEventListener("keypress",t=>{"Enter"===t.key&&(t.preventDefault(),searchTerm=e.value,renderRestaurantList(),scrollToResults())})}function initNearMe(){const e=document.getElementById("townNearMeBtn");e&&"function"==typeof window.openNearMe&&e.addEventListener("click",()=>{window.openNearMe()})}function initMapToggle(){const e=document.getElementById("mapToggle"),t=document.getElementById("mapContainer");e&&t&&e.addEventListener("click",()=>{const n=t.classList.toggle("show");e.textContent=n?"Hide Map":"Show Map",n&&map&&setTimeout(()=>{if(map.invalidateSize(),markers.length>0){const e=L.featureGroup(markers);map.fitBounds(e.getBounds().pad(.1))}},100)})}function initMap(){if(!document.getElementById("mapContainer")||"undefined"==typeof L)return;const e=data.restaurants.filter(e=>e.lat&&e.lng);if(0===e.length)return;const t=e.reduce((e,t)=>e+t.lat,0)/e.length,n=e.reduce((e,t)=>e+t.lng,0)/e.length;map=L.map("mapContainer").setView([t,n],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map),addMarkersToMap(e)}document.addEventListener("DOMContentLoaded",async()=>{await loadData(),addMobileScrollHints(),renderCategoryTabs(),renderFeaturedRestaurants(),renderRestaurantList(),initSearch(),initNearMe(),initMap(),initMapToggle()}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=document.querySelector(this.getAttribute("href"));if(t){const n=t.getBoundingClientRect().top+window.pageYOffset;window.scrollTo({top:n,behavior:"smooth"})}})});const townColors={Madison:"#EA580C",Clinton:"#DC2626",Westbrook:"#0891B2","Old Saybrook":"#9F1239"},townColor=townColors[townName]||"#1e3a6e";function createMarkerIcon(e){const t=e?40:30,n=e?"#f0b323":townColor,a=e?townColor:"#f0b323",r=e?12:10;return L.divIcon({className:"custom-marker",html:`<div style="\n            background-color: ${n};\n            width: ${t}px;\n            height: ${t}px;\n            border-radius: 50% 50% 50% 0;\n            transform: rotate(-45deg);\n            border: 3px solid ${a};\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            ${e?"box-shadow: 0 3px 10px rgba(0,0,0,0.3);":""}\n        "><span style="\n            transform: rotate(45deg);\n            width: ${r}px;\n            height: ${r}px;\n            background-color: ${e?townColor:"white"};\n            border-radius: 50%;\n        "></span></div>`,iconSize:[t,t],iconAnchor:[t/2,t],popupAnchor:[0,-t]})}function isFeaturedRestaurant(e){return data.featured&&data.featured.some(t=>t.name===e)}function addMarkersToMap(e){if(markers.forEach(e=>map.removeLayer(e)),markers=[],e.forEach(e=>{const t=isFeaturedRestaurant(e.name),n=createMarkerIcon(t),a=L.marker([e.lat,e.lng],{icon:n,zIndexOffset:t?1e3:0}).addTo(map).bindPopup(`\n                <div class="map-popup">\n                    <h4>${e.name}</h4>\n                    ${t?'<p class="popup-featured">⭐ FEATURED</p>':""}\n                    <p class="popup-cuisine">${e.category}</p>\n                    <p>${townName}</p>\n                    ${e.phone?`<p>${e.phone}</p>`:""}\n                </div>\n            `);markers.push(a)}),markers.length>0){const e=L.featureGroup(markers);map.fitBounds(e.getBounds().pad(.1))}}